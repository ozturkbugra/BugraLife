@model BugraLife.Models.FileManagerViewModel

@{
    ViewData["Title"] = "Dosya Paylaşım";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">

    <div class="card  border-secondary shadow-lg mb-3">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                    @if (Model.ParentPath != null)
                    {
                        <a href="/FileManager/Index?path=@Model.ParentPath" class="btn btn-outline-secondary me-2 flex-shrink-0" title="Bir Üst Klasör">
                            <i class="bi bi-arrow-90deg-up"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary me-2 flex-shrink-0" disabled><i class="bi bi-hdd"></i></button>
                    }
                    <h6 class=" mb-0 font-monospace text-truncate">
                        /paylasim/@(string.IsNullOrEmpty(Model.CurrentPath) ? "" : Model.CurrentPath)
                    </h6>
                </div>
                <div class="d-flex gap-2 action-buttons w-100-mobile">
                    <button class="btn btn-outline-warning fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                        <i class="bi bi-folder-plus me-1"></i> <span class="d-none d-sm-inline">Yeni</span> Klasör
                    </button>
                    <button class="btn btn-primary fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-cloud-upload me-1"></i> Yükle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card  border-secondary shadow-lg min-vh-100">
        <div class="card-body p-2 p-md-3">
            @if (Model.Directories.Count == 0 && Model.Files.Count == 0)
            {
                <div class="text-center py-5 text-secondary">
                    <i class="bi bi-folder2-open display-1 opacity-50"></i>
                    <p class="mt-3">Klasör boş aga. Bir şeyler yükle.</p>
                </div>
            }
            else
            {
                <div class="row g-2 g-md-3">

                    @foreach (var item in Model.Directories)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  bg-opacity-10 border-0 h-100 folder-card position-relative user-select-none">
                                <a href="/FileManager/Index?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small fw-bold" title="@item.Name">@item.Name</div>
                                </a>
                                <div class="card-actions position-absolute top-0 end-0 m-1">
                                    <div class="btn-group-vertical shadow-sm">
                                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteItem('@item.Path', 'klasör')" title="Sil"><i class="bi bi-x-lg"></i></button>
                                        <button class="btn btn-sm btn-info action-btn " onclick="renameItem('@item.Path', '@item.Name', true)" title="Düzenle"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-light action-btn" onclick="openMoveModal('@item.Path')" title="Taşı"><i class="bi bi-arrow-right-square"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @foreach (var item in Model.Files)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  border border-secondary h-100 file-card position-relative user-select-none">
                                <a href="javascript:void(0)" onclick="previewFile('@item.Path', '@item.Name', '@item.Extension')" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small" title="@item.Name">@item.Name</div>
                                    <div class="text-secondary small mt-1" style="font-size:0.7rem;">@item.Size</div>
                                </a>
                                <div class="card-actions position-absolute top-0 end-0 m-1">
                                    <div class="btn-group-vertical shadow-sm">
                                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteItem('@item.Path', 'dosya')" title="Sil"><i class="bi bi-x-lg"></i></button>
                                        <button class="btn btn-sm btn-info action-btn " onclick="renameItem('@item.Path', '@item.Name', false)" title="Düzenle"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-light action-btn" onclick="openMoveModal('@item.Path')" title="Taşı"><i class="bi bi-arrow-right-square"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="imagePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-header border-0 p-0 mb-2">
                <h5 class="modal-title  text-truncate pe-3" id="previewTitle">Dosya</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 text-center">
                <img id="previewImage" src="" class="img-fluid rounded shadow-lg" style="max-height: 85vh; object-fit: contain;" alt="Önizleme">
            </div>
            <div class="modal-footer border-0 justify-content-center mt-2">
                <a href="#" id="previewDownloadBtn" class="btn btn-warning fw-bold px-4 rounded-pill shadow-lg">
                    <i class="bi bi-download me-2"></i> İndir
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Yeni Klasör</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/FileManager/CreateFolder" method="post">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    <label class="form-label text-secondary">Klasör Adı</label>
                    <input type="text" name="folderName" class="form-control   border-0 py-2" required placeholder="Örn: Belgeler">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning fw-bold w-100">Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Öğeyi Taşı</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="moveItemPath">
                <label class="form-label text-secondary">Hedef Klasör</label>
                <select id="targetFolderSelect" class="form-select   border-0">
                    <option value="">Yükleniyor...</option>
                </select>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-success fw-bold w-100" onclick="submitMove()">Taşı</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Dosya Yükle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closeUploadModal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="currentPath" id="uploadCurrentPath" value="@Model.CurrentPath">

                <div class="mb-3">
                    <label for="fileInput" class="form-label text-warning fw-bold">1. Dosyaları Seç</label>
                    <input type="file" id="fileInput" class="form-control   border-0" multiple>
                </div>

                <div id="file-list-container" class="d-none">
                    <label class="form-label text-warning fw-bold">2. Düzenle ve Onayla</label>
                    <div class="file-list-wrapper  bg-opacity-10 rounded p-2" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="progress-container" class="mt-4" style="display:none;">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-warning small fw-bold" id="upload-status-text">Yükleniyor...</span>
                        <span class=" small fw-bold" id="progress-text">0%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div id="progress-bar" class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" onclick="clearFileList()">Temizle</button>
                <button type="button" class="btn btn-primary fw-bold" id="btnUpload" onclick="startUploadProcess()">
                    <i class="bi bi-cloud-upload me-1"></i> Yüklemeyi Başlat
                </button>
            </div>
        </div>
    </div>
</div>

<form id="deleteForm" action="/FileManager/Delete" method="post">
    <input type="hidden" name="path" id="deletePath">
</form>

<style>
    .filename-wrap {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        line-height: 1.3;
        max-height: 3.9em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    .file-list-item {
        background-color: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
        transition: 0.2s;
    }

        .file-list-item:hover {
            border-color: #ffc107;
        }

    .filename-input {
        background: transparent;
        color: white;
        border: none;
        border-bottom: 1px solid #6c757d;
        width: 100%;
    }

        .filename-input:focus {
            outline: none;
            border-bottom-color: #ffc107;
            color: #ffc107;
        }

    .card-actions {
        display: none;
        z-index: 10;
    }

    .folder-card:hover .card-actions, .file-card:hover .card-actions {
        display: block;
    }

    .action-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        line-height: 30px;
        border-radius: 4px;
        margin-bottom: 2px;
    }

    @@media (max-width: 768px) {
        .w-100-mobile {
            width: 100% !important;
            margin-top: 10px;
        }

        .card-actions {
            display: block !important;
            opacity: 0.9;
        }

        .folder-card, .file-card {
            min-height: 160px;
        }
    }
</style>

@section Scripts {
    <script>
        // --- 1. ÖNİZLEME ---
        function previewFile(path, name, extension) {
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp'];
            if (imageExtensions.includes(extension)) {
                const imageUrl = '/FileManager/Download?path=' + encodeURIComponent(path) + '&isInline=true';
                const downloadUrl = '/FileManager/Download?path=' + encodeURIComponent(path);
                $('#previewTitle').text(name);
                $('#previewImage').attr('src', imageUrl);
                $('#previewDownloadBtn').attr('href', downloadUrl);
                var myModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
                myModal.show();
            } else {
                window.location.href = '/FileManager/Download?path=' + encodeURIComponent(path);
            }
        }

        // --- 2. RENAME ---
        function renameItem(path, oldName, isFolder) {
            event.stopPropagation(); event.preventDefault();
            let editName = oldName;
            if (!isFolder && oldName.includes('.')) {
                let parts = oldName.split('.');
                if(parts.length > 1) { parts.pop(); editName = parts.join('.'); }
            }
            Swal.fire({
                title: 'Yeniden Adlandır', input: 'text', inputValue: editName,
                text: isFolder ? 'Klasör Adı:' : 'Dosya Adı:', showCancelButton: true,
                confirmButtonText: 'Kaydet', cancelButtonText: 'Vazgeç', background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    $.post('/FileManager/RenameItem', { currentPath: '@Model.CurrentPath', oldPath: path, newName: result.value }, function(res) {
                        if (res.success) location.reload(); else Swal.fire({icon:'error', title:'Hata', text: res.message, background:'#252b36', color:'#fff'});
                    });
                }
            });
        }

        // --- 3. MOVE ---
        function openMoveModal(path) {
            event.stopPropagation(); event.preventDefault();
            $('#moveItemPath').val(path);
            var modal = new bootstrap.Modal(document.getElementById('moveModal'));
            $('#targetFolderSelect').html('<option>Yükleniyor...</option>');
            $.get('/FileManager/GetAllFolders', function(data) {
                let options = '';
                data.forEach(function(f) {
                    if (path !== f.path && !f.path.startsWith(path + "/")) {
                         let isCurrent = '@Model.CurrentPath' === f.path;
                         options += `<option value="${f.path}" ${isCurrent ? 'disabled' : ''}>${f.name}${isCurrent ? ' (Buradasın)' : ''}</option>`;
                    }
                });
                $('#targetFolderSelect').html(options);
            });
            modal.show();
        }

        function submitMove() {
            let itemPath = $('#moveItemPath').val();
            let target = $('#targetFolderSelect').val();
            if (target === null) { Swal.fire({icon:'warning', title:'Seçim Yap', background:'#252b36', color:'#fff'}); return; }
            $.post('/FileManager/MoveItem', { itemPath: itemPath, targetFolderPath: target }, function(res) {
                if (res.success) location.reload(); else Swal.fire({icon:'error', title:'Hata', text: res.message, background:'#252b36', color:'#fff'});
            });
        }

        // --- 4. DELETE ---
        function deleteItem(path, type) {
            event.stopPropagation(); event.preventDefault();
            Swal.fire({
                title: 'Silinsin mi?', text: `Bu ${type} kalıcı olarak silinecek!`, icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Evet, Sil',
                background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) { $('#deletePath').val(path); $('#deleteForm').submit(); }
            });
        }

        // --- 5. UPLOAD (CHUNK) ---
        let selectedFilesQueue = [];
        const CHUNK_SIZE = 10 * 1024 * 1024; // 10 MB

        $('#fileInput').on('change', function() {
            const newFiles = this.files;
            for (let i = 0; i < newFiles.length; i++) { selectedFilesQueue.push({ file: newFiles[i], newName: newFiles[i].name }); }
            renderFileList(); $(this).val('');
        });

        function renderFileList() {
            const container = $('.file-list-wrapper');
            const listArea = $('#file-list-container');
            container.empty();
            if (selectedFilesQueue.length > 0) {
                listArea.removeClass('d-none');
                selectedFilesQueue.forEach((item, index) => {
                    const html = `
                        <div class="file-list-item d-flex align-items-center justify-content-between p-2 mb-2 rounded">
                            <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                                <i class="bi bi-file-earmark-fill text-warning fs-4 me-3"></i>
                                <div class="flex-grow-1 me-3">
                                    <input type="text" class="filename-input" value="${item.newName}" onchange="updateFileName(${index}, this.value)">
                                    <div class="text-muted small">Orj: ${item.file.name}</div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFileFromQueue(${index})"><i class="bi bi-x-lg"></i></button>
                        </div>`;
                    container.append(html);
                });
            } else { listArea.addClass('d-none'); }
        }

        window.updateFileName = function(idx, val) { if(!val.trim()) val = selectedFilesQueue[idx].file.name; selectedFilesQueue[idx].newName = val; };
        window.removeFileFromQueue = function(idx) { selectedFilesQueue.splice(idx, 1); renderFileList(); };
        window.clearFileList = function() { selectedFilesQueue = []; renderFileList(); };

        window.startUploadProcess = async function() {
            if (selectedFilesQueue.length === 0) { Swal.fire({icon:'warning', title:'Dosya Yok', background:'#252b36', color:'#fff'}); return; }
            $('#btnUpload').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Yükleniyor...');
            $('.filename-input').prop('disabled', true); $('#closeUploadModal').prop('disabled', true);
            $('.btn-outline-danger').prop('disabled', true); $('#progress-container').slideDown();

            const currentPath = $('#uploadCurrentPath').val();
            for (let i = 0; i < selectedFilesQueue.length; i++) {
                let item = selectedFilesQueue[i];
                try {
                    await uploadFileInChunks(item.file, item.newName, currentPath);
                    $('.file-list-item').eq(i).addClass('border-success').css('opacity', '0.5');
                } catch (error) {
                    Swal.fire({icon:'error', title:'Hata', text:'Hata: '+item.newName, background:'#252b36', color:'#fff'});
                    resetUI(); return;
                }
            }
            Swal.fire({icon:'success', title:'Tamamlandı', timer:1500, showConfirmButton:false, background:'#252b36', color:'#fff'}).then(()=>location.reload());
        };

        async function uploadFileInChunks(file, customFileName, currentPath) {
            let totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let start = 0; let chunkIndex = 0;
            $('#upload-status-text').text('Yükleniyor: ' + customFileName);
            while (start < file.size) {
                let end = Math.min(start + CHUNK_SIZE, file.size);
                let chunk = file.slice(start, end);
                let formData = new FormData();
                formData.append('chunk', chunk); formData.append('fileName', customFileName);
                formData.append('currentPath', currentPath); formData.append('chunkIndex', chunkIndex);
                formData.append('totalChunks', totalChunks);
                await $.ajax({ url: '/FileManager/UploadChunk', type: 'POST', data: formData, contentType: false, processData: false, timeout: 0 });
                let percent = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                $('#progress-bar').css('width', percent + '%'); $('#progress-text').text(percent + '%');
                start = end; chunkIndex++;
            }
        }

        function resetUI() {
            $('#btnUpload').prop('disabled', false).html('Yüklemeyi Başlat');
            $('.filename-input').prop('disabled', false); $('.btn-outline-danger').prop('disabled', false);
            $('#closeUploadModal').prop('disabled', false); $('#progress-container').hide();
        }
    </script>
}