@model BugraLife.Models.FileManagerViewModel

@{
    ViewData["Title"] = "Dosya Paylaşım";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">

    <div class="card  border-secondary shadow-lg mb-3">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">

                <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                    @if (Model.ParentPath != null)
                    {
                        <a href="/FileManager/Index?path=@Model.ParentPath" class="btn btn-outline-secondary me-2 flex-shrink-0" title="Bir Üst Klasör">
                            <i class="bi bi-arrow-90deg-up"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary me-2 flex-shrink-0" disabled><i class="bi bi-hdd"></i></button>
                    }

                    <h6 class=" mb-0 font-monospace text-truncate">
                        /paylasim/@(string.IsNullOrEmpty(Model.CurrentPath) ? "" : Model.CurrentPath)
                    </h6>
                </div>

                <div class="d-flex gap-2 action-buttons w-100-mobile">
                    <button class="btn btn-outline-warning fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                        <i class="bi bi-folder-plus me-1"></i> <span class="d-none d-sm-inline">Yeni</span> Klasör
                    </button>
                    <button class="btn btn-primary fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-cloud-upload me-1"></i> Yükle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card  border-secondary shadow-lg min-vh-100">
        <div class="card-body p-2 p-md-3">
            @if (Model.Directories.Count == 0 && Model.Files.Count == 0)
            {
                <div class="text-center py-5 text-secondary">
                    <i class="bi bi-folder2-open display-1 opacity-50"></i>
                    <p class="mt-3">Klasör boş aga. Bir şeyler yükle.</p>
                </div>
            }
            else
            {
                <div class="row g-2 g-md-3">

                    @foreach (var item in Model.Directories)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  bg-opacity-10 border-0 h-100 folder-card position-relative user-select-none">
                                <a href="/FileManager/Index?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small fw-bold" title="@item.Name">@item.Name</div>
                                </a>

                                <div class="card-actions position-absolute top-0 end-0 m-1">
                                    <div class="btn-group-vertical shadow-sm">
                                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteItem('@item.Path', 'klasör')" title="Sil"><i class="bi bi-x-lg"></i></button>
                                        <button class="btn btn-sm btn-info action-btn " onclick="renameItem('@item.Path', '@item.Name', true)" title="Düzenle"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-light action-btn" onclick="openMoveModal('@item.Path')" title="Taşı"><i class="bi bi-arrow-right-square"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @foreach (var item in Model.Files)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  border border-secondary h-100 file-card position-relative user-select-none">
                                <a href="javascript:void(0)" onclick="previewFile('@item.Path', '@item.Name', '@item.Extension')" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small" title="@item.Name">@item.Name</div>
                                    <div class="text-secondary small mt-1" style="font-size:0.7rem;">@item.Size</div>
                                </a>

                                <div class="card-actions position-absolute top-0 end-0 m-1">
                                    <div class="btn-group-vertical shadow-sm">
                                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteItem('@item.Path', 'dosya')" title="Sil"><i class="bi bi-x-lg"></i></button>
                                        <button class="btn btn-sm btn-info action-btn " onclick="renameItem('@item.Path', '@item.Name', false)" title="Düzenle"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-light action-btn" onclick="openMoveModal('@item.Path')" title="Taşı"><i class="bi bi-arrow-right-square"></i></button>
                                        <button class="btn btn-sm btn-primary action-btn text-white"
                                                onclick="openShareModal('@item.Path', '@item.Name')"
                                                title="Paylaş">
                                            <i class="bi bi-share-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-link-45deg me-2 text-primary"></i>Dosya Paylaş</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">

                <input type="hidden" id="shareCurrentPath">
                <input type="hidden" id="shareFileName">
                <input type="hidden" id="shareToken">

                <div class="mb-3">
                    <p class=" small">Aşağıdaki linke sahip olan herkes bu dosyayı indirebilir.</p>

                    <div class="input-group">
                        <input type="text" id="shareLinkInput" class="form-control bg-secondary  border-0" readonly>
                        <button class="btn btn-primary" onclick="copyShareLink()">
                            <i class="bi bi-clipboard"></i> Kopyala
                        </button>
                    </div>
                </div>

                <div id="shareActiveArea" style="display:none;">
                    <div class="alert alert-success bg-opacity-25 bg-success  border-0 d-flex align-items-center justify-content-between p-2">
                        <small><i class="bi bi-check-circle-fill me-1"></i> Bağlantı aktif</small>
                        <button class="btn btn-sm btn-danger py-0" onclick="revokeLink()">İptal Et</button>
                    </div>
                </div>

                <div id="shareLoadingArea" class="text-center py-3" style="display:none;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content  border-secondary">
            <div class="modal-header border-secondary py-2">
                <h6 class="modal-title  text-truncate" id="previewTitle">Dosya Önizleme</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-black" style="min-height: 400px; max-height: 85vh; overflow: auto;">
                <div id="previewContent" class="w-100 h-100 d-flex justify-content-center align-items-center">
                </div>
            </div>
            <div class="modal-footer border-secondary py-1 justify-content-center">
                <a href="#" id="previewDownloadBtn" class="btn btn-warning btn-sm fw-bold px-4 rounded-pill">
                    <i class="bi bi-download me-2"></i> Dosyayı İndir
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Yeni Klasör</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/FileManager/CreateFolder" method="post">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    <label class="form-label text-secondary">Klasör Adı</label>
                    <input type="text" name="folderName" class="form-control   border-0 py-2" required placeholder="Örn: Belgeler">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning fw-bold w-100">Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Öğeyi Taşı</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="moveItemPath">
                <label class="form-label text-secondary">Hedef Klasör</label>
                <select id="targetFolderSelect" class="form-select   border-0">
                    <option value="">Yükleniyor...</option>
                </select>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-success fw-bold w-100" onclick="submitMove()">Taşı</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Dosya Yükle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closeUploadModal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" name="currentPath" id="uploadCurrentPath" value="@Model.CurrentPath">

                <div class="mb-3">
                    <label for="fileInput" class="form-label text-warning fw-bold">1. Dosyaları Seç</label>
                    <input type="file" id="fileInput" class="form-control   border-0" multiple>
                </div>

                <div id="file-list-container" class="d-none">
                    <label class="form-label text-warning fw-bold">2. Düzenle ve Onayla</label>
                    <div class="file-list-wrapper  bg-opacity-10 rounded p-2" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <div id="progress-container" class="mt-4" style="display:none;">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-warning small fw-bold" id="upload-status-text">Yükleniyor...</span>
                        <span class=" small fw-bold" id="progress-text">0%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div id="progress-bar" class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" onclick="clearFileList()">Temizle</button>
                <button type="button" class="btn btn-primary fw-bold" id="btnUpload" onclick="startUploadProcess()">
                    <i class="bi bi-cloud-upload me-1"></i> Yüklemeyi Başlat
                </button>
            </div>
        </div>
    </div>
</div>

<form id="deleteForm" action="/FileManager/Delete" method="post">
    <input type="hidden" name="path" id="deletePath">
</form>

<style>
    /* Uzun Dosya İsimleri */
    .filename-wrap {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        line-height: 1.3;
        max-height: 3.9em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    /* Yükleme Listesi */
    .file-list-item {
        background-color: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.1);
        transition: 0.2s;
    }

        .file-list-item:hover {
            border-color: #ffc107;
        }

    .filename-input {
        background: transparent;
        color: white;
        border: none;
        border-bottom: 1px solid #6c757d;
        width: 100%;
    }

        .filename-input:focus {
            outline: none;
            border-bottom-color: #ffc107;
            color: #ffc107;
        }

    /* Butonlar ve Kartlar */
    .card-actions {
        display: none;
        z-index: 10;
    }

    .folder-card:hover .card-actions, .file-card:hover .card-actions {
        display: block;
    }

    .action-btn {
        width: 30px;
        height: 30px;
        padding: 0;
        line-height: 30px;
        border-radius: 4px;
        margin-bottom: 2px;
    }

    /* Mobil Ayarlar */
    @@media (max-width: 768px) {
        .w-100-mobile {
            width: 100% !important;
            margin-top: 10px;
        }

        .card-actions {
            display: block !important;
            opacity: 0.9;
        }
        /* Mobilde hep görünsün */
        .folder-card, .file-card {
            min-height: 160px;
        }
    }
</style>

@section Scripts {
    <script>
        // --- 0. AKILLI DOSYA ÖNİZLEME (WORD, EXCEL, TXT, PDF, IMG) ---
        function previewFile(path, name, extension) {
            const ext = extension.toLowerCase();
            const encodedPath = encodeURIComponent(path);
            const downloadUrl = '/FileManager/Download?path=' + encodedPath;
            const viewUrl = '/FileManager/Download?path=' + encodedPath + '&isInline=true';

            const modalTitle = $('#previewTitle');
            const modalContent = $('#previewContent');
            const downloadBtn = $('#previewDownloadBtn');
            const myModal = new bootstrap.Modal(document.getElementById('previewModal'));

            modalTitle.text(name);
            modalContent.empty();
            downloadBtn.attr('href', downloadUrl);

            // A. RESİM
            if (['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp'].includes(ext)) {
                modalContent.html(`<img src="${viewUrl}" class="img-fluid" style="max-height: 80vh;" alt="Resim">`);
                myModal.show();
            }
            // B. VIDEO / SES
            else if (['.mp4', '.webm', '.ogg', '.mov'].includes(ext)) {
                modalContent.html(`<video controls autoplay class="w-100" style="max-height: 80vh;"><source src="${viewUrl}" type="video/mp4"></video>`);
                myModal.show();
            }
            else if (['.mp3', '.wav'].includes(ext)) {
                modalContent.html(`<div class="p-5 text-center"><i class="bi bi-music-note-beamed display-1 text-success mb-4"></i><br><audio controls autoplay class="w-100 mt-3"><source src="${viewUrl}" type="audio/mpeg"></audio></div>`);
                myModal.show();
            }
            // C. PDF
            else if (ext === '.pdf') {
                modalContent.html(`<iframe src="${viewUrl}" style="width:100%; height:80vh;" frameborder="0"></iframe>`);
                myModal.show();
            }
            // D. METİN (KOD)
            else if (['.txt', '.css', '.js', '.json', '.xml', '.md', '.cs', '.html', '.cshtml', '.log', '.ini'].includes(ext)) {
                modalContent.html('<div class="spinner-border text-light" role="status"></div>');
                myModal.show();
                $.get(viewUrl, function(data) {
                    const escapedData = $('<div>').text(data).html();
                    modalContent.html(`<pre class=" text-light p-3 w-100 h-100 m-0 text-start" style="overflow:auto; height: 80vh; white-space: pre-wrap; font-family: monospace;">${escapedData}</pre>`);
                }).fail(function() { modalContent.html('<div class="text-danger">Okunamadı.</div>'); });
            }
            // E. OFFICE (GOOGLE DOCS - Sadece Canlıda Çalışır)
            else if (['.docx', '.doc', '.xlsx', '.xls', '.pptx', '.ppt'].includes(ext)) {
                const fullUrl = window.location.origin + viewUrl;
                const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fullUrl)}&embedded=true`;
                modalContent.html(`<iframe src="${googleViewerUrl}" style="width:100%; height:80vh;" frameborder="0"></iframe>`);
                myModal.show();
            }
            // F. DİĞER (DİREKT İNDİR)
            else {
                window.location.href = downloadUrl;
            }
        }

        // --- 1. RENAME ---
        function renameItem(path, oldName, isFolder) {
            event.stopPropagation(); event.preventDefault();
            let editName = oldName;
            if (!isFolder && oldName.includes('.')) {
                let parts = oldName.split('.');
                if(parts.length > 1) { parts.pop(); editName = parts.join('.'); }
            }
            Swal.fire({
                title: 'Yeniden Adlandır', input: 'text', inputValue: editName,
                text: isFolder ? 'Klasör adı:' : 'Dosya adı (uzantı korunur):',
                showCancelButton: true, confirmButtonText: 'Kaydet', cancelButtonText: 'Vazgeç',
                background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    $.post('/FileManager/RenameItem', { currentPath: '@Model.CurrentPath', oldPath: path, newName: result.value }, function(res) {
                        if (res.success) location.reload(); else Swal.fire({icon:'error', title:'Hata', text: res.message, background:'#252b36', color:'#fff'});
                    });
                }
            });
        }

        // --- 2. MOVE ---
        function openMoveModal(path) {
            event.stopPropagation(); event.preventDefault();
            $('#moveItemPath').val(path);
            var modal = new bootstrap.Modal(document.getElementById('moveModal'));
            $('#targetFolderSelect').html('<option>Yükleniyor...</option>');
            $.get('/FileManager/GetAllFolders', function(data) {
                let options = '';
                data.forEach(function(f) {
                    if (path !== f.path && !f.path.startsWith(path + "/")) {
                         let isCurrent = '@Model.CurrentPath' === f.path;
                         options += `<option value="${f.path}" ${isCurrent ? 'disabled' : ''}>${f.name}${isCurrent ? ' (Buradasın)' : ''}</option>`;
                    }
                });
                $('#targetFolderSelect').html(options);
            });
            modal.show();
        }

        function submitMove() {
            let itemPath = $('#moveItemPath').val();
            let target = $('#targetFolderSelect').val();
            if (target === null) { Swal.fire({icon:'warning', title:'Seçim Yap', background:'#252b36', color:'#fff'}); return; }
            $.post('/FileManager/MoveItem', { itemPath: itemPath, targetFolderPath: target }, function(res) {
                if (res.success) location.reload(); else Swal.fire({icon:'error', title:'Hata', text: res.message, background:'#252b36', color:'#fff'});
            });
        }

        // --- 3. DELETE ---
        function deleteItem(path, type) {
            event.stopPropagation(); event.preventDefault();
            Swal.fire({
                title: 'Silinsin mi?', text: `Bu ${type} kalıcı olarak silinecek!`, icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Evet, Sil',
                background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) { $('#deletePath').val(path); $('#deleteForm').submit(); }
            });
        }

        // --- 4. UPLOAD (GELİŞMİŞ CHUNK) ---
        let selectedFilesQueue = [];
        const CHUNK_SIZE = 10 * 1024 * 1024; // 10 MB Parça

        $('#fileInput').on('change', function() {
            const newFiles = this.files;
            for (let i = 0; i < newFiles.length; i++) { selectedFilesQueue.push({ file: newFiles[i], newName: newFiles[i].name }); }
            renderFileList(); $(this).val('');
        });

        function renderFileList() {
            const container = $('.file-list-wrapper');
            const listArea = $('#file-list-container');
            container.empty();
            if (selectedFilesQueue.length > 0) {
                listArea.removeClass('d-none');
                selectedFilesQueue.forEach((item, index) => {
                    const html = `
                        <div class="file-list-item d-flex align-items-center justify-content-between p-2 mb-2 rounded">
                            <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                                <i class="bi bi-file-earmark-fill text-warning fs-4 me-3"></i>
                                <div class="flex-grow-1 me-3">
                                    <input type="text" class="filename-input" value="${item.newName}" onchange="updateFileName(${index}, this.value)">
                                    <div class=" small">Orj: ${item.file.name} | ${formatBytes(item.file.size)}</div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="removeFileFromQueue(${index})"><i class="bi bi-x-lg"></i></button>
                        </div>`;
                    container.append(html);
                });
            } else { listArea.addClass('d-none'); }
        }

        window.updateFileName = function(idx, val) { if(!val.trim()) val = selectedFilesQueue[idx].file.name; selectedFilesQueue[idx].newName = val; };
        window.removeFileFromQueue = function(idx) { selectedFilesQueue.splice(idx, 1); renderFileList(); };
        window.clearFileList = function() { selectedFilesQueue = []; renderFileList(); };

        window.startUploadProcess = async function() {
            if (selectedFilesQueue.length === 0) { Swal.fire({icon:'warning', title:'Dosya Yok', background:'#252b36', color:'#fff'}); return; }
            $('#btnUpload').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Yükleniyor...');
            $('.filename-input').prop('disabled', true); $('#closeUploadModal').prop('disabled', true);
            $('.btn-outline-danger').prop('disabled', true); $('#progress-container').slideDown();

            const currentPath = $('#uploadCurrentPath').val();
            for (let i = 0; i < selectedFilesQueue.length; i++) {
                let item = selectedFilesQueue[i];
                try {
                    await uploadFileInChunks(item.file, item.newName, currentPath);
                    $('.file-list-item').eq(i).addClass('border-success').css('opacity', '0.5');
                } catch (error) {
                    Swal.fire({icon:'error', title:'Hata', text:'Hata: '+item.newName, background:'#252b36', color:'#fff'});
                    resetUI(); return;
                }
            }
            Swal.fire({icon:'success', title:'Tamamlandı', timer:1500, showConfirmButton:false, background:'#252b36', color:'#fff'}).then(()=>location.reload());
        };

        async function uploadFileInChunks(file, customFileName, currentPath) {
            let totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let start = 0; let chunkIndex = 0;
            $('#upload-status-text').text('Yükleniyor: ' + customFileName);
            while (start < file.size) {
                let end = Math.min(start + CHUNK_SIZE, file.size);
                let chunk = file.slice(start, end);
                let formData = new FormData();
                formData.append('chunk', chunk); formData.append('fileName', customFileName);
                formData.append('currentPath', currentPath); formData.append('chunkIndex', chunkIndex);
                formData.append('totalChunks', totalChunks);
                await $.ajax({ url: '/FileManager/UploadChunk', type: 'POST', data: formData, contentType: false, processData: false, timeout: 0 });
                let percent = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                $('#progress-bar').css('width', percent + '%'); $('#progress-text').text(percent + '%');
                start = end; chunkIndex++;
            }
        }

        function resetUI() {
            $('#btnUpload').prop('disabled', false).html('Yüklemeyi Başlat');
            $('.filename-input').prop('disabled', false); $('.btn-outline-danger').prop('disabled', false);
            $('#closeUploadModal').prop('disabled', false); $('#progress-container').hide();
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024; const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }



        function openShareModal(path, name) {
            // Mobilde tıklamayı durdur
            event.stopPropagation();
            event.preventDefault();

            // Sadece dosya adını al (path içinde klasör adı da olabilir)
            // Bizim controller createShareLink(currentPath, fileName) bekliyor.
            // Ama burada path zaten "Klasör/Dosya.jpg" formatında geliyor.
            // O yüzden currentPath boş, fileName = path olarak gönderebiliriz ya da ayrıştırabiliriz.
            // En temizi: Path'i olduğu gibi kullanalım, Controller'da düzenlemiştik.

            // UI Hazırla
            $('#shareFileName').val(name);
            $('#shareLinkInput').val('');
            $('#shareActiveArea').hide();
            $('#shareLoadingArea').show();

            var modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();

            // Link Oluştur / Getir
            $.post('/FileManager/CreateShareLink', {
                currentPath: '', // Path zaten full geliyor
                fileName: path
            }, function(response) {
                $('#shareLoadingArea').hide();
                if (response.success) {
                    $('#shareLinkInput').val(response.url);
                    $('#shareToken').val(response.token);
                    $('#shareActiveArea').fadeIn();
                } else {
                    $('#shareLinkInput').val('Hata oluştu.');
                }
            });
        }

        function copyShareLink() {
            var copyText = document.getElementById("shareLinkInput");
            copyText.select();
            copyText.setSelectionRange(0, 99999); // Mobil için
            navigator.clipboard.writeText(copyText.value).then(() => {
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success',
                    title: 'Link kopyalandı!', showConfirmButton: false, timer: 2000,
                    background: '#252b36', color: '#fff'
                });
            });
        }

        function revokeLink() {
            var token = $('#shareToken').val();
            Swal.fire({
                title: 'Emin misin?',
                text: "Bu link iptal edilecek, artık kimse indiremeyecek!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Evet, İptal Et',
                cancelButtonText: 'Vazgeç',
                background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/FileManager/RevokeShare', { token: token }, function(response) {
                        if (response.success) {
                            $('#shareModal').modal('hide');
                            Swal.fire({icon:'success', title:'Link Pasif Edildi', timer:1500, showConfirmButton:false, background:'#252b36', color:'#fff'});
                        }
                    });
                }
            });
        }
    </script>
}