@model BugraLife.Models.FileManagerViewModel

@{
    ViewData["Title"] = "Dosya Paylaşım";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">

    <div class="card  border-secondary shadow-lg mb-3">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">

                <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                    @if (Model.ParentPath != null)
                    {
                        <a href="/FileManager/Index?path=@Model.ParentPath" class="btn btn-outline-secondary me-2 flex-shrink-0" title="Bir Üst Klasör">
                            <i class="bi bi-arrow-90deg-up"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary me-2 flex-shrink-0" disabled><i class="bi bi-hdd"></i></button>
                    }

                    <h6 class=" mb-0 font-monospace text-truncate">
                        /paylasim/@(string.IsNullOrEmpty(Model.CurrentPath) ? "" : Model.CurrentPath)
                    </h6>
                </div>

                <div class="d-flex gap-2 action-buttons w-100-mobile">
                    <button class="btn btn-outline-warning fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                        <i class="bi bi-folder-plus me-1"></i> <span class="d-none d-sm-inline">Yeni</span> Klasör
                    </button>
                    <button class="btn btn-primary fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-cloud-upload me-1"></i> Yükle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card  border-secondary shadow-lg min-vh-100">
        <div class="card-body p-2 p-md-3">
            @if (Model.Directories.Count == 0 && Model.Files.Count == 0)
            {
                <div class="text-center py-5 text-secondary">
                    <i class="bi bi-folder2-open display-1 opacity-50"></i>
                    <p class="mt-3">Klasör boş aga.</p>
                </div>
            }
            else
            {
                <div class="row g-2 g-md-3">

                    @foreach (var item in Model.Directories)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card bg-secondary bg-opacity-10 border-0 h-100 folder-card position-relative user-select-none">
                                <a href="/FileManager/Index?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 text-truncate small fw-bold" title="@item.Name">@item.Name</div>
                                </a>

                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-btn shadow-sm"
                                        onclick="deleteItem('@item.Path', 'klasör')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    }

                    @foreach (var item in Model.Files)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  border border-secondary h-100 file-card position-relative user-select-none">
                                <a href="/FileManager/Download?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 text-truncate small" title="@item.Name">@item.Name</div>
                                    <div class="text-secondary small mt-1" style="font-size:0.7rem;">@item.Size</div>
                                </a>

                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-btn shadow-sm"
                                        onclick="deleteItem('@item.Path', 'dosya')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Yeni Klasör</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/FileManager/CreateFolder" method="post">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    <label class="form-label text-secondary">Klasör Adı</label>
                    <input type="text" name="folderName" class="form-control bg-secondary  border-0 py-2" required placeholder="Örn: Belgeler">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning fw-bold w-100">Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Dosya Yükle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/FileManager/UploadFile" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    <label class="form-label text-secondary">Dosyaları Seç</label>
                    <input type="file" name="files" class="form-control bg-secondary  border-0" multiple required>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-primary fw-bold w-100">Yüklemeyi Başlat</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" action="/FileManager/Delete" method="post">
    <input type="hidden" name="path" id="deletePath">
</form>

<style>
    /* Masaüstü Hover Efektleri */
    .folder-card:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
        transition: 0.2s;
    }

    .file-card:hover {
        border-color: #ffc107 !important;
        transition: 0.2s;
    }

    /* Silme Butonu Varsayılan: Gizli */
    .delete-btn {
        display: none;
        z-index: 10;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
        line-height: 32px;
    }

    /* Masaüstünde Hover yapınca göster */
    .folder-card:hover .delete-btn, .file-card:hover .delete-btn {
        display: block;
    }

    /* --- MOBİL ÖZEL AYARLAR (768px altı) --- */
    @@media (max-width: 768px) {
        /* Butonları Alt Alta Değil, Tam Genişlikte Yap */
        .w-100-mobile {
            width: 100% !important;
            margin-top: 10px;
        }
        /* Silme butonu mobilde HEP görünsün */
        .delete-btn {
            display: block !important;
            opacity: 0.8; /* Biraz şeffaf olsun ki altı görünsün */
        }

        .folder-card, .file-card {
            min-height: 140px; /* Mobilde kartlar biraz daha uzun olsun, basması kolay olsun */
        }
    }
</style>

@section Scripts {
    <script>
        function deleteItem(path, type) {
            // Mobilde yanlışlıkla basmayı önlemek için event'i durdur (Linke gitmesin)
            event.stopPropagation();
            event.preventDefault();

            Swal.fire({
                title: 'Silinsin mi?',
                text: `Bu ${type} kalıcı olarak silinecek!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonText: 'Vazgeç',
                confirmButtonText: 'Evet, Sil',
                background: document.documentElement.getAttribute('data-theme') === 'dark' ? '#252b36' : '#fff',
                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#fff' : '#333'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#deletePath').val(path);
                    $('#deleteForm').submit();
                }
            });
        }
    </script>
}