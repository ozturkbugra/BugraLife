@model BugraLife.Models.FileManagerViewModel

@{
    ViewData["Title"] = "Dosya Paylaşım";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">

    <div class="card  border-secondary shadow-lg mb-3">
        <div class="card-body p-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                
                <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                    @if (Model.ParentPath != null)
                    {
                        <a href="/FileManager/Index?path=@Model.ParentPath" class="btn btn-outline-secondary me-2 flex-shrink-0" title="Bir Üst Klasör">
                            <i class="bi bi-arrow-90deg-up"></i>
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-outline-secondary me-2 flex-shrink-0" disabled><i class="bi bi-hdd"></i></button>
                    }
                    
                    <h6 class=" mb-0 font-monospace text-truncate">
                        /paylasim/@(string.IsNullOrEmpty(Model.CurrentPath) ? "" : Model.CurrentPath)
                    </h6>
                </div>

                <div class="d-flex gap-2 action-buttons w-100-mobile">
                    <button class="btn btn-outline-warning fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                        <i class="bi bi-folder-plus me-1"></i> <span class="d-none d-sm-inline">Yeni</span> Klasör
                    </button>
                    <button class="btn btn-primary fw-bold flex-fill" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-cloud-upload me-1"></i> Yükle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card  border-secondary shadow-lg min-vh-100">
        <div class="card-body p-2 p-md-3">
            @if (Model.Directories.Count == 0 && Model.Files.Count == 0)
            {
                <div class="text-center py-5 text-secondary">
                    <i class="bi bi-folder2-open display-1 opacity-50"></i>
                    <p class="mt-3">Klasör boş aga. Bir şeyler yükle.</p>
                </div>
            }
            else
            {
                <div class="row g-2 g-md-3">

                    @foreach (var item in Model.Directories)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  bg-opacity-10 border-0 h-100 folder-card position-relative user-select-none">
                                <a href="/FileManager/Index?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small fw-bold" title="@item.Name">@item.Name</div>
                                </a>

                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-btn shadow-sm" 
                                        onclick="deleteItem('@item.Path', 'klasör')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    }

                    @foreach (var item in Model.Files)
                    {
                        <div class="col-6 col-md-4 col-lg-2">
                            <div class="card  border border-secondary h-100 file-card position-relative user-select-none">
                                <a href="/FileManager/Download?path=@item.Path" class="text-decoration-none  p-3 text-center d-block h-100">
                                    <i class="bi @item.Icon display-4"></i>
                                    <div class="mt-2 filename-wrap small" title="@item.Name">@item.Name</div>
                                    <div class="text-secondary small mt-1" style="font-size:0.7rem;">@item.Size</div>
                                </a>

                                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 delete-btn shadow-sm" 
                                        onclick="deleteItem('@item.Path', 'dosya')">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Yeni Klasör</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/FileManager/CreateFolder" method="post">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    <label class="form-label text-secondary">Klasör Adı</label>
                    <input type="text" name="folderName" class="form-control   border-0 py-2" required placeholder="Örn: Belgeler">
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning fw-bold w-100">Oluştur</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Dosya Yükle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closeUploadModal"></button>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" name="currentPath" value="@Model.CurrentPath">
                    
                    <label class="form-label text-secondary">Dosyaları Seç</label>
                    <input type="file" name="files" id="fileInput" class="form-control   border-0" multiple required>
                    
                    <div id="progress-container" class="mt-4" style="display:none;">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-warning small fw-bold" id="upload-status-text">Yükleniyor...</span>
                            <span class=" small fw-bold" id="progress-text">0%</span>
                        </div>
                        <div class="progress " style="height: 10px;">
                            <div id="progress-bar" class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2 text-muted small">Lütfen bekleyin, büyük dosyalar zaman alabilir.</div>
                    </div>

                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-primary fw-bold w-100" id="btnUpload">
                        <i class="bi bi-cloud-upload me-1"></i> Yüklemeyi Başlat
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" action="/FileManager/Delete" method="post">
    <input type="hidden" name="path" id="deletePath">
</form>

<style>
    /* 1. DOSYA İSMİ KAYDIRMA (Taşmayı önler) */
    .filename-wrap {
        white-space: normal !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        line-height: 1.3;
        max-height: 3.9em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    /* 2. HOVER EFEKTLERİ */
    .folder-card:hover { background-color: rgba(255, 193, 7, 0.2) !important; transition: 0.2s; }
    .file-card:hover { border-color: #ffc107 !important; transition: 0.2s; }

    /* 3. SİLME BUTONU (Varsayılan: Gizli) */
    .delete-btn { display: none; z-index: 10; width: 32px; height: 32px; border-radius: 50%; padding: 0; line-height: 32px; }

    /* Masaüstünde Hover yapınca göster */
    .folder-card:hover .delete-btn, .file-card:hover .delete-btn { display: block; }

    /* --- MOBİL ÖZEL AYARLAR (768px altı) --- */
    @@media (max-width: 768px) {
        .w-100-mobile {
            width: 100% !important;
            margin-top: 10px;
        }
        
        .delete-btn {
            display: block !important;
            opacity: 0.8; 
        }
        
        .folder-card, .file-card {
            min-height: 150px; 
        }
    }
</style>

@section Scripts {
    <script>
        // 1. SİLME İŞLEMİ (AYNI)
        function deleteItem(path, type) {
            event.stopPropagation();
            event.preventDefault();
            Swal.fire({
                title: 'Silinsin mi?',
                text: `Bu ${type} kalıcı olarak silinecek!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonText: 'Vazgeç', confirmButtonText: 'Evet, Sil',
                background: '#252b36', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#deletePath').val(path);
                    $('#deleteForm').submit();
                }
            });
        }

        // =========================================================
        // 2. PARÇALI YÜKLEME (CHUNK UPLOAD) MANTIĞI
        // =========================================================
        $(document).ready(function() {
            
            // Sabitler
            const CHUNK_SIZE = 1 * 1024 * 1024; // 1 MB (Sunucuyu hiç yormaz)
            let isUploading = false;

            $('#uploadForm').submit(async function(e) {
                e.preventDefault();

                var btn = $('#btnUpload');
                var fileInput = $('#fileInput');
                var files = fileInput.get(0).files;
                var currentPath = $('input[name="currentPath"]').val();

                if (files.length === 0) {
                    Swal.fire({ icon: 'warning', title: 'Dosya Yok', text: 'Lütfen dosya seçin.', background: '#252b36', color: '#fff' });
                    return;
                }

                // UI Kilitle
                isUploading = true;
                btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Yükleniyor...');
                $('#closeUploadModal').prop('disabled', true);
                $('#progress-container').slideDown();
                
                // --- DOSYALARI SIRAYLA YÜKLE ---
                for (let i = 0; i < files.length; i++) {
                    let file = files[i];
                    
                    try {
                        await uploadFileInChunks(file, currentPath);
                    } catch (error) {
                        console.error(error);
                        Swal.fire({ icon: 'error', title: 'Hata', text: 'Yükleme sırasında hata oluştu: ' + file.name, background: '#252b36', color: '#fff' });
                        resetUI();
                        return;
                    }
                }

                // Hepsi Bitti
                Swal.fire({
                    icon: 'success', title: 'Tamamlandı', text: 'Tüm dosyalar başarıyla yüklendi.',
                    timer: 1500, showConfirmButton: false, background: '#252b36', color: '#fff'
                }).then(() => location.reload());
            });

            // --- TEK BİR DOSYAYI PARÇALAYIP GÖNDEREN FONKSİYON ---
            async function uploadFileInChunks(file, currentPath) {
                let totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                let start = 0;
                let chunkIndex = 0;

                // Dosya adı güncelleme
                $('#upload-status-text').text('Yükleniyor: ' + file.name);

                while (start < file.size) {
                    let end = Math.min(start + CHUNK_SIZE, file.size);
                    let chunk = file.slice(start, end); // Dosyadan 1 dilim al

                    let formData = new FormData();
                    formData.append('chunk', chunk);
                    formData.append('fileName', file.name);
                    formData.append('currentPath', currentPath);
                    formData.append('chunkIndex', chunkIndex);
                    formData.append('totalChunks', totalChunks);

                    // Parçayı Gönder (Promise ile bekle)
                    await $.ajax({
                        url: '/FileManager/UploadChunk',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        // Hata olursa döngüyü kırar ve catch bloğuna düşer
                    });

                    // İlerleme Çubuğunu Güncelle
                    let percent = Math.round(((chunkIndex + 1) / totalChunks) * 100);
                    $('#progress-bar').css('width', percent + '%');
                    $('#progress-text').text(percent + '%');

                    // Sonraki parçaya geç
                    start = end;
                    chunkIndex++;
                }
            }

            function resetUI() {
                isUploading = false;
                $('#btnUpload').prop('disabled', false).html('<i class="bi bi-cloud-upload me-1"></i> Yüklemeyi Başlat');
                $('#closeUploadModal').prop('disabled', false);
                $('#progress-container').hide();
            }
        });
    </script>
}