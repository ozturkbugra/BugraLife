@model List<BugraLife.Models.ActivityDefinition>

@{
    ViewData["Title"] = "Aktivite Takibi";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var definitions = ViewBag.Definitions as List<BugraLife.Models.ActivityDefinition>;
}

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
    /* --- MASAÜSTÜ & GENEL --- */
    .fc-event-main {
        cursor: pointer;
    }

    .fc-event {
        border: none;
    }

    #external-events .fc-event {
        cursor: grab;
        margin-bottom: 8px;
        padding: 10px;
        border-left: 4px solid; /* Renk sadece solda şerit olsun */
        background-color: #2c3034;
        color: #fff;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    /* Takvim Renkleri */
    .fc {
        color: #e0e0e0;
    }

    .fc-theme-standard td, .fc-theme-standard th {
        border-color: #373b3e;
    }

    .fc-col-header-cell-cushion {
        color: #adb5bd;
        text-decoration: none;
    }

    .fc-daygrid-day-number {
        color: #adb5bd;
        text-decoration: none;
    }

    .fc-button-primary {
        background-color: #2c3034 !important;
        border-color: #373b3e !important;
    }

    .fc-button-active {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
        color: #000 !important;
    }

    .fc-today-button {
        text-transform: capitalize;
    }

    /* --- MOBİL İÇİN FAB BUTONU (Yuvarlak + Butonu) --- */
    .mobile-fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        background-color: #ffc107;
        color: #000;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        z-index: 1000;
        border: none;
        transition: transform 0.2s;
    }

        .mobile-fab:active {
            transform: scale(0.9);
        }

    /* Masaüstünde FAB gizle */
    @@media (min-width: 768px) {
        .mobile-fab {
            display: none;
        }
    }

    /* Mobilde Takvim Ayarları */
    @@media (max-width: 768px) {
        .fc-toolbar-title {
            font-size: 1.2rem !important;
        }

        .fc-header-toolbar {
            flex-wrap: wrap;
            gap: 10px;
        }
        /* Mobilde olaylar daha sade görünsün */
        .fc-event {
            font-size: 0.75rem;
        }
    }

    /* Offcanvas içindeki liste */
    .activity-list-item {
        background-color: #2c3034;
        border-left: 4px solid #666;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 4px;
        cursor: pointer;
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">

        <div class="col-md-3 d-none d-md-block">
            <div class="card border-secondary shadow-lg h-100">
                <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-list-task me-2 text-warning"></i>Aktiviteler</h5>
                    <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#createModal">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="external-events">
                        <p class="text-secondary small fst-italic mb-3">Takvime sürükle bırak.</p>
                        @foreach (var item in definitions)
                        {
                            <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event"
                                 data-id="@item.activitydefinition_id"
                                 data-title="@item.name"
                                 data-color="@item.color"
                                 style="border-color: @item.color"
                                 onclick="openEditModal('@item.activitydefinition_id', '@item.name', '@item.color')">
                                <div class="fc-event-main d-flex justify-content-between align-items-center">
                                    <span>@item.name</span>
                                    <i class="bi bi-grip-vertical text-secondary"></i>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9 col-12">
            <div class="card border-secondary shadow-lg">
                <div class="card-body p-2 p-md-3">
                    <div id="calendar" style="min-height: 80vh;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<button class="mobile-fab" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
    <i class="bi bi-plus"></i>
</button>

<div class="offcanvas offcanvas-bottom  " tabindex="-1" id="mobileMenu" style="height: 60vh; border-top: 1px solid #444;">
    <div class="offcanvas-header border-bottom border-secondary">
        <h5 class="offcanvas-title fw-bold text-warning">Aktiviteler</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">

        <button class="btn btn-warning w-100 mb-3 fw-bold" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="bi bi-plus-lg me-2"></i>Yeni Tanım Ekle
        </button>

        <p class=" small mb-2">Takvime eklemek için güne tıkla. Düzenlemek için aşağıdan seç:</p>

        <div id="mobile-list">
            @foreach (var item in definitions)
            {
                <div class="activity-list-item d-flex justify-content-between align-items-center"
                     style="border-color: @item.color;"
                     onclick="openEditModal('@item.activitydefinition_id', '@item.name', '@item.color')">
                    <span class="fw-bold">@item.name</span>
                    <i class="bi bi-pencil-square text-secondary"></i>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="selectActivityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Ne Yaptın?</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selectedDateForAdd">

                @foreach (var item in definitions)
                {
                    <div class="p-3 mb-2 rounded border border-secondary d-flex align-items-center gap-3"
                         style="cursor: pointer; background: rgba(255,255,255,0.05);"
                         onclick="addActivityFromModal('@item.activitydefinition_id')">
                        <div style="width: 20px; height: 20px; background-color: @item.color; border-radius: 50%;"></div>
                        <span class="fw-bold fs-5">@item.name</span>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-warning">Yeni Aktivite</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Adı</label>
                        <input type="text" name="name" class="form-control   border-0" required placeholder="Örn: Kitap Okuma">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Renk</label>
                        <input type="color" name="color" class="form-control form-control-color border-secondary w-100" value="#3788d8">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning w-100 fw-bold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary ">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-info">Düzenle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" name="activitydefinition_id" id="edit_id">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Adı</label>
                        <input type="text" name="name" id="edit_name" class="form-control   border-0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Renk</label>
                        <input type="color" name="color" id="edit_color" class="form-control form-control-color border-secondary w-100">
                    </div>
                </div>
                <div class="modal-footer border-secondary d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteDefinition()"><i class="bi bi-trash"></i> Sil</button>
                    <button type="submit" class="btn btn-primary fw-bold">Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var calendar;

        document.addEventListener('DOMContentLoaded', function() {
            var containerEl = document.getElementById('external-events');
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function(eventEl) {
                    return {
                        title: eventEl.getAttribute('data-title'),
                        backgroundColor: eventEl.getAttribute('data-color'),
                        borderColor: eventEl.getAttribute('data-color'),
                        extendedProps: { defId: eventEl.getAttribute('data-id') }
                    };
                }
            });

            var calendarEl = document.getElementById('calendar');
            var isMobile = window.innerWidth < 768;

            calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth,listWeek' : 'dayGridMonth,dayGridWeek,listWeek'
                },
                initialView: 'dayGridMonth',
                locale: 'tr',
                firstDay: 1,
                editable: false,
                droppable: true,
                height: 'auto', // Yüksekliği otomatiğe al
                contentHeight: isMobile ? 'auto' : 600,
                events: '/Activity/GetCalendarEvents',

                // MASAÜSTÜ SÜRÜKLE BIRAK
                eventReceive: function(info) {
                    saveActivity(info.event.extendedProps.defId, info.event.startStr, info.event);
                },

                // HEM MOBİL HEM MASAÜSTÜ: GÜNE TIKLAYINCA EKLE
                dateClick: function(info) {
                    $('#selectedDateForAdd').val(info.dateStr);
                    $('#selectActivityModal').modal('show');
                },

                // SİLME İŞLEMİ
                eventClick: function(info) {
                    Swal.fire({
                        title: 'Silinsin mi?', text: info.event.title, icon: 'warning',
                        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Sil', cancelButtonText: 'Vazgeç',
                        background: '#252b36', color: '#fff'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post('/Activity/DeleteLog', { id: info.event.id }, function(res) {
                                if(res.success) { info.event.remove(); showToast('success', 'Silindi.'); }
                            });
                        }
                    });
                }
            });
            calendar.render();
        });

        function addActivityFromModal(defId) {
            var dateStr = $('#selectedDateForAdd').val();
            $.post('/Activity/LogActivity', { defId: defId, date: dateStr }, function(res) {
                if(res.success) {
                    calendar.refetchEvents();
                    $('#selectActivityModal').modal('hide');
                    showToast('success', 'Eklendi!');
                } else {
                    Swal.fire({icon:'error', title:'Hata', text:res.message, background:'#252b36', color:'#fff'});
                }
            });
        }

        function saveActivity(defId, dateStr, calendarEventObj) {
            $.post('/Activity/LogActivity', { defId: defId, date: dateStr }, function(res) {
                if(res.success) {
                    calendarEventObj.setProp('id', res.id);
                    showToast('success', 'Eklendi.');
                } else {
                    calendarEventObj.remove();
                    Swal.fire({icon:'error', title:'Hata', text:res.message, background:'#252b36', color:'#fff'});
                }
            });
        }

        // --- CRUD FONKSİYONLARI ---
        $('#createForm').submit(function(e) { e.preventDefault(); $.post('/Activity/CreateDefinition', $(this).serialize(), function(res) { if(res.success) location.reload(); }); });
        $('#editForm').submit(function(e) { e.preventDefault(); $.post('/Activity/EditDefinition', $(this).serialize(), function(res) { if(res.success) location.reload(); }); });

        function openEditModal(id, name, color) { $('#edit_id').val(id); $('#edit_name').val(name); $('#edit_color').val(color); $('#editModal').modal('show'); }

        function deleteDefinition() {
            var id = $('#edit_id').val();
            if(confirm('Tanımı silmek istiyor musun?')) { $.post('/Activity/DeleteDefinition', { id: id }, function(res) { if(res.success) location.reload(); }); }
        }
    </script>
}