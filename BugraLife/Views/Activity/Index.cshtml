@{
    ViewData["Title"] = "Aktivite Takibi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
    /* --- SÜRÜKLENEBİLİR KUTULAR (SOL MENÜ) --- */
    .fc-event-main {
        cursor: pointer;
    }

    #external-events .fc-event {
        cursor: grab;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #373b3e;
        color: #fff;
        border-radius: 5px;
        transition: all 0.2s;
        display: block; /* Arama filtresi için önemli */
    }

        #external-events .fc-event:hover {
            transform: translateX(5px);
            border-color: #ffc107; /* Warning rengi */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

    /* ARAMA KUTUSU */
    .search-box2 {
        background-color: var(--input-bg);
        color: var(--input-text);
        border: 1px solid #495057;
        padding: 10px;
        border-radius: 5px;
        width: 100%;
        margin-bottom: 15px;
    }

        .search-box2:focus {
            background-color: var(--input-bg);
            outline: none;
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

    /* --- FULLCALENDAR DARK MODE AYARLARI --- */
    .fc {
        color: #e0e0e0;
    }

    .fc-theme-standard .fc-scrollgrid,
    .fc-theme-standard td,
    .fc-theme-standard th {
        border-color: #373b3e;
    }

    .fc-col-header-cell-cushion,
    .fc-daygrid-day-number {
        color: #adb5bd;
        text-decoration: none;
    }

    .fc-button-primary {
        background-color: #2c3034 !important;
        border-color: #373b3e !important;
    }

    .fc-button-active {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
    }

    
</style>

<div class="container-fluid mt-4">
    <div class="row">

        <div class="col-md-3">
            <div class="card  border-secondary shadow-lg h-100">
                <div class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold ">
                        <i class="bi bi-list-task me-2 text-warning"></i>Aktiviteler
                    </h5>
                    <button class="btn btn-sm btn-warning fw-bold" data-bs-toggle="modal" data-bs-target="#createModal">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="card-body">

                    <input type="text" id="activitySearch" class="search-box2" placeholder="Aktivite ara..." onkeyup="filterActivities()">

                    <div id="external-events">
                        <p class="text-secondary small fst-italic mb-3">Takvime sürükle ve bırak.</p>

                        <div id="activity-list">
                            @foreach (var item in ViewBag.Definitions as List<BugraLife.Models.ActivityDefinition>)
                            {
                                <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event"
                                     data-id="@item.activitydefinition_id"
                                     data-title="@item.name"
                                     data-color="@item.color"
                                     onclick="openEditModal('@item.activitydefinition_id', '@item.name', '@item.color')">
                                    <div class="fc-event-main d-flex justify-content-between align-items-center">
                                        <span class="activity-name fw-bold">@item.name</span>
                                        <i class="bi bi-grip-vertical text-secondary"></i>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card  border-secondary shadow-lg">
                <div class="card-body p-3">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary  shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fw-bold text-warning">Yeni Aktivite Tanımla</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Aktivite Adı</label>
                        <input type="text" name="name" class="form-control bg-secondary  border-0" required placeholder="Örn: 30dk Yürüyüş">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Renk Seç</label>
                        <input type="color" name="color" class="form-control form-control-color  border-secondary w-100" value="#3788d8">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="submit" class="btn btn-warning fw-bold">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content  border-secondary  shadow-lg">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fw-bold text-info">Aktivite Düzenle</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" name="activitydefinition_id" id="edit_id">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Aktivite Adı</label>
                        <input type="text" name="name" id="edit_name" class="form-control bg-secondary  border-0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Renk</label>
                        <input type="color" name="color" id="edit_color" class="form-control form-control-color  border-secondary w-100">
                    </div>
                </div>
                <div class="modal-footer border-secondary d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteDefinition()">
                        <i class="bi bi-trash me-1"></i>Tanımı Sil
                    </button>
                    <button type="submit" class="btn btn-primary fw-bold">Güncelle</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var calendar; // Global erişim için

        // 1. ARAMA
        function filterActivities() {
            var input = document.getElementById('activitySearch');
            var filter = input.value.toUpperCase();
            var list = document.getElementById("activity-list");
            var items = list.getElementsByClassName('fc-event');

            for (var i = 0; i < items.length; i++) {
                var span = items[i].getElementsByClassName("activity-name")[0];
                var txtValue = span.textContent || span.innerText;
                items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        }

        document.addEventListener('DOMContentLoaded', function() {

            // 2. DRAGGABLE
            var containerEl = document.getElementById('external-events');
            new FullCalendar.Draggable(containerEl, {
                itemSelector: '.fc-event',
                eventData: function(eventEl) {
                    return {
                        title: eventEl.getAttribute('data-title'),
                        backgroundColor: eventEl.getAttribute('data-color'),
                        borderColor: eventEl.getAttribute('data-color'),
                        extendedProps: {
                            defId: eventEl.getAttribute('data-id')
                        }
                    };
                }
            });

            // 3. CALENDAR
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                initialView: 'dayGridMonth',
                locale: 'tr',
                firstDay: 1,
                editable: false,
                droppable: true,
                events: '/Activity/GetCalendarEvents',

                // A. EVENT BIRAKILDI (CREATE LOG)
                // "eventReceive" drop işleminden sonra oluşan event'i yakalar
                eventReceive: function(info) {
                    var defId = info.event.extendedProps.defId;
                    var dateStr = info.event.startStr; // "2024-01-01"

                    // AJAX ile kaydet
                    $.ajax({
                        url: '/Activity/LogActivity',
                        type: 'POST',
                        data: { defId: defId, date: dateStr },
                        success: function(res) {
                            if(res.success) {
                                // Başarılıysa, DB'den gelen gerçek ID'yi bu event'e atıyoruz.
                                // Böylece silmek istersek ID'sini bileceğiz.
                                info.event.setProp('id', res.id);
                                showToast('success', 'Aktivite işlendi.');
                            } else {
                                // Başarısız (Aynı gün var)
                                info.event.remove(); // Takvimden sil
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Hata',
                                    text: res.message,
                                    confirmButtonColor: '#d33',
                                    background: '#252b36', color: '#fff'
                                });
                            }
                        },
                        error: function() {
                            info.event.remove();
                            showToast('error', 'Sunucu hatası.');
                        }
                    });
                },

                // B. EVENT TIKLANDI (DELETE LOG)
                eventClick: function(info) {
                    Swal.fire({
                        title: 'Kayıt Silinsin mi?',
                        text: info.event.title,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Evet, Sil',
                        cancelButtonText: 'Vazgeç',
                        background: '#252b36', color: '#fff'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: '/Activity/DeleteLog',
                                type: 'POST',
                                data: { id: info.event.id },
                                success: function(res) {
                                    if(res.success) {
                                        info.event.remove(); // Sayfa yenilemeden kaldır
                                        showToast('success', 'Silindi.');
                                    }
                                }
                            });
                        }
                    });
                }
            });
            calendar.render();
        });

        // --- 4. CRUD İŞLEMLERİ (SAYFA YENİLEMEDEN) ---

        // YENİ EKLE
        $('#createForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: '/Activity/CreateDefinition',
                type: 'POST',
                data: $(this).serialize(),
                success: function(res) {
                    if(res.success) {
                        // Yeni HTML oluştur ve listeye ekle
                        var newItem = res.item;
                        var html = `
                            <div class="fc-event fc-h-event fc-daygrid-event fc-daygrid-block-event"
                                 id="def-${newItem.activitydefinition_id}"
                                 data-id="${newItem.activitydefinition_id}"
                                 data-title="${newItem.name}"
                                 data-color="${newItem.color}"
                                 onclick="openEditModal('${newItem.activitydefinition_id}', '${newItem.name}', '${newItem.color}')">
                                <div class="fc-event-main d-flex justify-content-between align-items-center">
                                    <span class="activity-name fw-bold">${newItem.name}</span>
                                    <i class="bi bi-grip-vertical text-secondary"></i>
                                </div>
                            </div>`;

                        $('#activity-list').append(html);

                        // Formu temizle ve modalı kapat
                        $('#createForm')[0].reset();
                        $('#createModal').modal('hide');
                        showToast('success', 'Aktivite eklendi.');
                    } else {
                        showToast('error', 'Hata oluştu.');
                    }
                }
            });
        });

        // MODAL AÇ (Verileri doldur)
        function openEditModal(id, name, color) {
            $('#edit_id').val(id);
            $('#edit_name').val(name);
            $('#edit_color').val(color);
            $('#editModal').modal('show');
        }

        // GÜNCELLE
        // GÜNCELLEME İŞLEMİ (SAYFA YENİLEMEDEN)
        // GÜNCELLEME (SAYFA YENİLEYEREK)
        $('#editForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: '/Activity/EditDefinition',
                type: 'POST',
                data: $(this).serialize(),
                success: function(res) {
                    if(res.success) {
                        // En temizi: Sayfayı yenile
                        location.reload();
                    } else {
                        showToast('error', 'Güncellenemedi.');
                    }
                }
            });
        });

        // SİL
        function deleteDefinition() {
            var id = $('#edit_id').val();
            if(confirm('Silmek istediğine emin misin? (Geçmiş kayıtlar da gider)')) {
                $.ajax({
                    url: '/Activity/DeleteDefinition',
                    type: 'POST',
                    data: { id: id },
                    success: function(res) {
                        if(res.success) {
                            // 1. Listeden sil
                            $('#def-' + id).remove();
                            // 2. Takvimden sil
                            calendar.refetchEvents();

                            $('#editModal').modal('hide');
                            showToast('success', 'Silindi.');
                        }
                    }
                });
            }
        }
    </script>
}