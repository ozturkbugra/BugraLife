<script>
    /* =========================================================
    BugraLife Admin Panel - Ana JavaScript Dosyası (FULL SÜRÜM)
    ========================================================= */

    // 1. GLOBAL TOAST FONKSİYONU (Her yerden erişilebilir)
    function showToast(icon, title) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        Toast.fire({
            icon: icon, // 'success', 'error', 'warning', 'info'
            title: title
        });
    }

    $(document).ready(function() {

        // =========================================================
        // 2. SIDEBAR (SOL MENÜ) İŞLEMLERİ
        // =========================================================
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });

        // --- AKILLI MENÜ ARAMA (Accordion Destekli) ---
        $('#menu-search-input').on('keyup', function() {
            var value = $(this).val().toLowerCase();

            // Tüm menü elemanlarını (linkleri) kontrol et
            $('.list-group-item').filter(function() {
                // Linkin metnini al
                var text = $(this).text().toLowerCase();
                var isMatch = text.indexOf(value) > -1;

                // Eğer arama kutusu boşsa her şeyi eski haline getir
                if (value === "") {
                    $('.collapse').removeClass('show'); // Alt menüleri kapat

                    // Sadece ana başlıkları ve accordion içinde olmayanları göster
                    // (Bu mantık basit tutulmuştur, CSS yapına göre otomatik düzelir)
                    $(this).toggle(true);

                    // Alt menü elemanlarını tekrar gizlemek gerekebilir ama
                    // collapse sınıfı zaten onları gizleyecektir.
                    return;
                }

                // Eşleşme varsa
                if (isMatch) {
                    $(this).toggle(true);

                    // Eğer bu eleman bir alt menünün içindeyse, o alt menüyü AÇ
                    $(this).closest('.collapse').addClass('show');

                    // Bu alt menünün başlığını da (Accordion Header) görünür yap
                    var collapseId = $(this).closest('.collapse').attr('id');
                    if(collapseId) {
                        $('a[href="#' + collapseId + '"]').toggle(true);
                    }

                } else {
                    // Eşleşme yoksa gizle
                    $(this).toggle(false);
                }
            });

            // Eğer bir grup başlığı (accordion header) arama sonucu boşsa ve altındakiler de boşsa onu gizle
            // Bu biraz karmaşık olabilir, şimdilik yukarıdaki mantık işini görür.
        });


        // =========================================================
        // 3. MOBİL ARAMA
        // =========================================================
        $("#mobile-search-toggle").click(function() {
            $("#search-container-wrapper").toggleClass("active");
            if ($("#search-container-wrapper").hasClass("active")) {
                $("#menu-search-input").focus();
            }
        });


        // =========================================================
        // 4. DATATABLES OTOMATİK KURULUM
        // =========================================================
        if ($.fn.DataTable) {
            $('.datatable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
                },
                responsive: true,
                drawCallback: function() {
                    $('.page-link').addClass('shadow-sm');
                }
            });
        }


        // =========================================================
        // 5. DARK MODE (GECE MODU)
        // =========================================================
        const themeToggleBtn = document.getElementById('dark-mode-toggle');
        const themeIcon = document.getElementById('theme-icon');

        if (themeToggleBtn) {
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme) {
                document.documentElement.setAttribute('data-theme', currentTheme);
                if (currentTheme === 'dark') {
                    themeIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
                }
            }

            themeToggleBtn.addEventListener('click', () => {
                let theme = document.documentElement.getAttribute('data-theme');
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                    themeIcon.classList.replace('bi-sun-fill', 'bi-moon-stars-fill');
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    themeIcon.classList.replace('bi-moon-stars-fill', 'bi-sun-fill');
                }
            });
        }


        // =========================================================
        // 6. AGA SELECT (AKILLI SEÇİM KUTUSU)
        // =========================================================
        $('.aga-select').each(function() {
            const originalSelect = $(this);
            const isMulti = originalSelect.prop('multiple'); // Çoklu mu Tekli mi?

            originalSelect.hide(); // Orjinal select'i gizle

            // --- A. Seçenekleri Hazırla ---
            let optionsHtml = '';
            originalSelect.find('option').each(function() {
                const val = $(this).val();
                const text = $(this).text();
                const isSelected = $(this).is(':selected');

                if (val === "") return; // Placeholder'ı atla

                if (isMulti) {
                    // Çoklu Mod (Checkbox)
                    optionsHtml += `
                        <label class="aga-option-item ${isSelected ? 'selected' : ''}">
                            <input type="checkbox" value="${val}" data-text="${text}" ${isSelected ? 'checked' : ''}>
                            <span>${text}</span>
                        </label>
                    `;
                } else {
                    // Tekli Mod (Div)
                    optionsHtml += `
                        <div class="aga-option-item ${isSelected ? 'selected' : ''}" data-value="${val}" data-text="${text}">
                            <span>${text}</span>
                        </div>
                    `;
                }
            });

            // --- B. HTML İskeleti ---
            const selectAllHtml = isMulti ? '<span class="select-all-btn">Tümünü Seç / Kaldır</span>' : '';

            const wrapper = $(`
                <div class="aga-select-wrapper">
                    <div class="aga-select-trigger">Seçiniz...</div>
                    <div class="aga-select-dropdown">
                        <input type="text" class="aga-search-box" placeholder="Ara...">
                        ${selectAllHtml}
                        <div class="aga-options-list">
                            ${optionsHtml}
                        </div>
                    </div>
                </div>
            `);

            originalSelect.after(wrapper);

            // --- C. Değişkenler ---
            const trigger = wrapper.find('.aga-select-trigger');
            const dropdown = wrapper.find('.aga-select-dropdown');
            const searchBox = wrapper.find('.aga-search-box');

            // --- D. Trigger Yazısını Güncelleme ---
            function updateTriggerText() {
                if (isMulti) {
                    const checked = wrapper.find('input[type="checkbox"]:checked');
                    if (checked.length > 0) {
                        if (checked.length > 2) {
                            trigger.text(checked.length + " kayıt seçildi");
                        } else {
                            const texts = checked.map(function() { return $(this).attr('data-text'); }).get();
                            trigger.text(texts.join(', '));
                        }
                        trigger.css('color', 'var(--text-color)');
                    } else {
                        trigger.text("Seçiniz...");
                        trigger.css('color', 'var(--text-muted)');
                    }
                } else {
                    // Tekli Mod
                    const selected = wrapper.find('.aga-option-item.selected');
                    if (selected.length > 0) {
                        trigger.text(selected.data('text'));
                        trigger.css('color', 'var(--text-color)');
                    } else {
                        trigger.text("Seçiniz...");
                        trigger.css('color', 'var(--text-muted)');
                    }
                }
            }

            // Başlangıçta çalıştır
            updateTriggerText();


            // --- E. DIŞARIDAN DEĞİŞİM (EDIT BUTONU TETİKLERSE) ---
            originalSelect.on('change', function() {
                const newVal = $(this).val();

                if (!isMulti) {
                    // Tekli Mod: Görseli güncelle
                    wrapper.find('.aga-option-item').removeClass('selected');
                    if(newVal) {
                        wrapper.find(`.aga-option-item[data-value='${newVal}']`).addClass('selected');
                    }
                }
                // Kutunun üzerindeki yazıyı güncelle
                updateTriggerText();
            });


            // --- F. Etkileşimler ---

            // 1. Dropdown Aç/Kapa
            trigger.on('click', function(e) {
                e.stopPropagation();
                $('.aga-select-dropdown').not(dropdown).removeClass('active');
                dropdown.toggleClass('active');
                if(dropdown.hasClass('active')) {
                    searchBox.focus();
                }
            });

            // 2. Dışarı tıklayınca kapat
            $(document).on('click', function() {
                dropdown.removeClass('active');
            });
            dropdown.on('click', function(e) { e.stopPropagation(); });

            // 3. Arama Kutusu
            searchBox.on('keyup', function() {
                const value = $(this).val().toLocaleLowerCase('tr-TR');
                wrapper.find('.aga-option-item').filter(function() {
                    $(this).toggle($(this).text().toLocaleLowerCase('tr-TR').indexOf(value) > -1)
                });
            });

            // --- G. Seçim İşlemleri (Moda Göre) ---

            if (isMulti) {
                // [ÇOKLU MOD]
                const selectAllBtn = wrapper.find('.select-all-btn');
                const checkboxes = wrapper.find('input[type="checkbox"]');

                // Tümünü Seç
                selectAllBtn.on('click', function() {
                    const allChecked = checkboxes.length === checkboxes.filter(':checked').length;
                    checkboxes.prop('checked', !allChecked).trigger('change');
                });

                // Checkbox değişince
                checkboxes.on('change', function() {
                    const selectedValues = [];
                    checkboxes.filter(':checked').each(function() {
                        selectedValues.push($(this).val());
                        $(this).closest('.aga-option-item').addClass('selected');
                    });

                    checkboxes.not(':checked').closest('.aga-option-item').removeClass('selected');

                    // Değeri güncelle ama trigger yapma (sonsuz döngü olmasın diye)
                    originalSelect.val(selectedValues);
                    updateTriggerText();
                });

            } else {
                // [TEKLİ MOD]
                const items = wrapper.find('.aga-option-item');

                items.on('click', function() {
                    const val = $(this).data('value');

                    // Görsel güncelleme
                    items.removeClass('selected');
                    $(this).addClass('selected');

                    // Orjinal select'i güncelle ve CHANGE olayını tetikle
                    originalSelect.val(val).trigger('change');

                    // Menüyü kapat
                    dropdown.removeClass('active');
                });
            }
        });


        var currentUrl = window.location.pathname.toLowerCase();

        // Eğer kök dizindeysek (/), /Home varsayalım
        if (currentUrl === "/" || currentUrl === "") currentUrl = "/home";

        $("#sidebar-menu .menu-item").each(function() {
            var linkUrl = $(this).attr("href").toLowerCase();

            // Eşleşme Mantığı:
            // 1. Tam Eşleşme: /Activity == /Activity
            // 2. Alt Sayfa Eşleşmesi: /Activity/Create sayfası da /Activity linkini yaksın
            // (Ancak /Home linki, /Home/Index dışında başka sayfaları yakmasın diye kontrol ekledik)

            if (currentUrl === linkUrl || (currentUrl.startsWith(linkUrl) && linkUrl !== "/home" && linkUrl !== "/")) {

                // 1. Linki Aktif Yap (Sarı Arkaplan)
                $(this).addClass("active-menu");
                $(this).removeClass("bg-transparent second-text"); // Eski şeffaf stili kaldır

                // 2. Eğer bu link bir alt menünün (Accordion) içindeyse...
                var parentCollapse = $(this).closest(".collapse");
                if (parentCollapse.length > 0) {

                    // A. Menüyü Aç
                    parentCollapse.addClass("show");

                    // B. Menü Başlığını (Örn: Finansal İşlemler) Renklendir
                    var parentId = parentCollapse.attr("id");
                    var parentToggle = $('a[href="#' + parentId + '"]');
                    parentToggle.addClass("active-parent");
                    parentToggle.removeClass("collapsed"); // Ok yönünü düzelt
                    parentToggle.attr("aria-expanded", "true");
                }
            }
        });
    });

    $(document).on('keydown', function(e) {
            // Eğer odak zaten bir input, textarea veya select üzerindeyse veya CTRL/ALT tuşlarına basılıysa karışma
            if ($(e.target).is('input, textarea, select') || e.ctrlKey || e.altKey || e.metaKey) {
                return;
            }

            // Basılan tuş bir harf (A-Z) veya sayı (0-9) ise
            // (KeyCode kontrolü yerine key length kontrolü daha modern ve evrenseldir)
            if (e.key.length === 1) {
                var searchInput = $("#menu-search-input");

                // Arama kutusuna odaklan
                searchInput.focus();

                // Eğer mobil menü kapalıysa ve mobildeysek aç (Opsiyonel)
                if ($(window).width() <= 768 && !$("#wrapper").hasClass("toggled")) {
                }
            }
        });

        // Sayfa ilk yüklendiğinde de (Eğer masaüstüyse) direkt odaklan
        if ($(window).width() > 768) {
             $("#menu-search-input").focus();
        }
</script>