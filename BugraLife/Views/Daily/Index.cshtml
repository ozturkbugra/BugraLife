@{
    ViewData["Title"] = "Günlük Takvimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Html.AntiForgeryToken()

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<style>
    /* --- GENEL & DARK MODE AYARLARI --- */
    #calendar {
        background-color: var(--bs-body-bg);
        padding: 10px;
        border-radius: 15px;
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
    }

    /* FullCalendar Çizgi ve Renk Ayarları */
    .fc-theme-standard .fc-scrollgrid, 
    .fc-theme-standard td, 
    .fc-theme-standard th {
        border-color: var(--bs-border-color) !important;
    }
    .fc .fc-view-harness { background-color: transparent !important; }

    /* Yazı Renkleri */
    .fc-col-header-cell-cushion,
    .fc-daygrid-day-number {
        color: var(--bs-body-color) !important;
        text-decoration: none !important;
    }

    /* Bugün */
    .fc-day-today {
        background-color: rgba(25, 135, 84, 0.1) !important; /* Hafif Yeşil */
    }

    /* Etkinlik Kutuları */
    .fc-event {
        border: none;
        border-radius: 4px;
        padding: 3px 5px;
        font-size: 0.85rem;
        justify-content: center; /* Yazıyı ortala */
        text-align: center;
        font-weight: bold;
    }

    /* MOBİL AYARLARI */
    @@media (max-width: 768px) {
        .fc-header-toolbar {
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px !important;
            justify-content: center !important;
        }
        .fc-toolbar-title { font-size: 1.1rem !important; margin: 0 10px !important; }
        .fc-button { padding: 0.2rem 0.5rem !important; font-size: 0.75rem !important; }
        .fc-col-header-cell-cushion { font-size: 0.8rem; }
        .fc-daygrid-day-number { font-size: 0.8rem; padding: 2px !important; }
        .fc-event { font-size: 0.7rem !important; padding: 1px 2px !important; }
        .fc-view-harness { min-height: 400px; }
    }
</style>

<div class="container-fluid mt-2 mb-5 p-1">
    <div id='calendar'></div>
</div>

<div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-success">
                    <i class="bi bi-journal-plus me-2"></i>Günlük Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createForm">
                <div class="modal-body">
                    <input type="hidden" name="daily_date" id="create_date">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Günün Nasıl Geçti?</label>
                        <select name="daily_status" class="form-select" required>
                            <option value="4" selected>🤩 Süper</option>
                            <option value="3">🙂 İyi</option>
                            <option value="2">😐 Orta</option>
                            <option value="1">😡 Kötü</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Neler Oldu?</label>
                        <textarea name="daily_description" class="form-control" rows="4" required placeholder="Bugünü anlat..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-info">
                    <i class="bi bi-journal-text me-2"></i>Günlük Detayı
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" name="daily_id" id="edit_id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Günün Nasıl Geçti?</label>
                        <select name="daily_status" id="edit_status" class="form-select" required>
                            <option value="4">🤩 Süper</option>
                            <option value="3">🙂 İyi</option>
                            <option value="2">😐 Orta</option>
                            <option value="1">😡 Kötü</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Neler Oldu?</label>
                        <textarea name="daily_description" id="edit_desc" class="form-control" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteEvent()">
                        <i class="bi bi-trash me-1"></i> Sil
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Kapat</button>
                        <button type="submit" class="btn btn-info text-white">Güncelle</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

@section Scripts {
    <script>
        var calendar;

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth', 
                locale: 'tr',
                firstDay: 1, 
                
                headerToolbar: {
                    left: 'prev,next', 
                    center: 'title',   
                    right: 'today'     
                },
                
                buttonText: { today: 'Bugün' },

                height: 'auto',
                contentHeight: 'auto',
                dayMaxEvents: true, 
                
                editable: false, // SÜRÜKLE BIRAK KAPALI
                selectable: true,
                events: '/Daily/GetEvents',

                // 1. BOŞ GÜNE TIKLAMA -> EKLE
                dateClick: function(info) {
                    $('#create_date').val(info.dateStr);
                    $('textarea[name="daily_description"]').val('');
                    $('select[name="daily_status"]').val('4'); // Varsayılan Süper
                    $('#createModal').modal('show');
                },

                // 2. DOLU GÜNE (ETKİNLİĞE) TIKLAMA -> DÜZENLE
                eventClick: function(info) {
                    var eventObj = info.event;
                    var props = eventObj.extendedProps;

                    $('#edit_id').val(eventObj.id);
                    $('#edit_desc').val(props.description);
                    $('#edit_status').val(props.statusId);

                    $('#editModal').modal('show');
                }
            });

            calendar.render();
        });

        // --- EKLEME ---
        $('#createForm').submit(function(e){
            e.preventDefault();
            var formData = $(this).serialize();
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({ 
                url: '/Daily/Create', 
                type: 'POST', 
                data: formData + "&__RequestVerificationToken=" + token,
                success: function(res) { 
                    if(res.success){ 
                        $('#createModal').modal('hide'); 
                        calendar.refetchEvents(); 
                        showToast('success', res.message); 
                    } else {
                        showToast('error', res.message); // "Bugün zaten kayıt var" hatası burada çıkar
                    }
                }
            });
        });

        // --- GÜNCELLEME ---
        $('#editForm').submit(function(e){
            e.preventDefault();
            var formData = $(this).serialize();
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({ 
                url: '/Daily/Edit', 
                type: 'POST', 
                data: formData + "&__RequestVerificationToken=" + token,
                success: function(res) { 
                    if(res.success){ 
                        $('#editModal').modal('hide'); 
                        calendar.refetchEvents(); 
                        showToast('success', res.message); 
                    }
                }
            });
        });

        // --- SİLME ---
        function deleteEvent() {
            var id = $('#edit_id').val();
            Swal.fire({
                title: 'Silinsin mi?', 
                text: "Bu günlük kaydı silinecek.", 
                icon: 'warning', 
                showCancelButton: true, 
                confirmButtonColor: '#d33',
                confirmButtonText: 'Sil',
                cancelButtonText: 'Vazgeç',
                background: document.documentElement.getAttribute('data-theme') === 'dark' ? '#252b36' : '#fff',
                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#fff' : '#333'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({ 
                        url: '/Daily/Delete', 
                        type: 'POST', 
                        data: { id: id },
                        success: function(res) { 
                            if(res.success){ 
                                $('#editModal').modal('hide'); 
                                calendar.refetchEvents(); 
                                showToast('success', res.message); 
                            }
                        }
                    });
                }
            });
        }
    </script>
}