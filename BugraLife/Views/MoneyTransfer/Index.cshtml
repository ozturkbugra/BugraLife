@{
    ViewData["Title"] = "Hesaplar Arası Transfer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-success text-white py-3 rounded-top-4">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-arrow-left-right me-2"></i>Hesaplar Arası Transfer (Virman)
                    </h5>
                    <small class="text-white-50">Nakit ve Banka hesapları arası işlem</small>
                </div>

                <div class="card-body p-4">
                    <form id="transferForm">
                        @Html.AntiForgeryToken()

                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary">Gönderen Hesap (Kaynak)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary bg-opacity-10 border-end-0 text-danger">
                                    <i class="bi bi-box-arrow-up"></i>
                                </span>
                                <select name="sourceAccountId" id="sourceAccountId" class="form-select border-start-0 ps-0" required>
                                    <option value="">Seçiniz...</option>
                                    @foreach (var item in ViewBag.Accounts)
                                    {
                                        <option value="@item.paymenttype_id">
                                            @item.paymenttype_name (Mevcut: @item.paymenttype_balance.ToString("N2") ₺)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary">Alıcı Hesap (Hedef)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary bg-opacity-10 border-end-0 text-success">
                                    <i class="bi bi-box-arrow-in-down"></i>
                                </span>
                                <select name="targetAccountId" id="targetAccountId" class="form-select border-start-0 ps-0" required>
                                    <option value="">Seçiniz...</option>
                                    @foreach (var item in ViewBag.Accounts)
                                    {
                                        <option value="@item.paymenttype_id">
                                            @item.paymenttype_name (Mevcut: @item.paymenttype_balance.ToString("N2") ₺)
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-secondary">Transfer Tutarı</label>
                                <div class="input-group">
                                    <input type="number" name="amount" class="form-control" placeholder="0.00" step="0.01" required>
                                    <span class="input-group-text bg-secondary bg-opacity-10 text-secondary">₺</span>
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-danger">İşlem Ücreti (Komisyon)</label>
                                <div class="input-group">
                                    <input type="number" name="commission" class="form-control text-danger" placeholder="0.00" step="0.01" value="0">
                                    <span class="input-group-text bg-danger bg-opacity-10 text-danger">₺</span>
                                </div>
                                <small class="text-muted" style="font-size: 0.75rem;">Yoksa 0 bırakınız.</small>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-secondary">İşlem Tarihi</label>
                                <input type="datetime-local" name="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary">Açıklama (Opsiyonel)</label>
                            <textarea name="description" class="form-control" rows="2" placeholder="Örn: Kasa devir, borç verme..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow-sm hover-scale">
                            <i class="bi bi-send-fill me-2"></i>Transferi Tamamla
                        </button>

                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {

            // Aynı hesabı seçmeyi engellemek için ufak bir kontrol (Görsel)
            $('select').change(function() {
                var source = $('#sourceAccountId').val();
                var target = $('#targetAccountId').val();

                if(source && target && source == target) {
                    Swal.fire('Uyarı', 'Kaynak ve Hedef hesap aynı olamaz!', 'warning');
                    $(this).val(''); // Son seçimi iptal et
                }
            });

            // SweetAlert dark mode ayarı
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            const swalBackground = isDarkMode ? '#252b36' : '#fff';
            const swalColor = isDarkMode ? '#fff' : '#333';

                                    $('#transferForm').submit(function(e) {
            e.preventDefault();

            // 1. Değerleri alıp virgülü noktaya çeviriyoruz (Hem hesaplama hem gönderim için)
            var rawAmount = $('input[name="amount"]').val().replace(',', '.');
            var rawCommission = $('input[name="commission"]').val().replace(',', '.');

            var amount = parseFloat(rawAmount) || 0;
            var commission = parseFloat(rawCommission) || 0;
            var total = amount + commission;

            // 2. Onay Mesajı Hazırlığı
            var textMessage = "Hesaptan çıkacak: " + amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " ₺";
            if(commission > 0){
                textMessage += "\n+ " + commission.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " ₺ Masraf";
                textMessage += "\nTOPLAM DÜŞÜLECEK: " + total.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + " ₺";
            }

            Swal.fire({
                title: 'Transfer Onayı',
                text: textMessage,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Evet, Transfer Et',
                cancelButtonText: 'Vazgeç',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                background: swalBackground,
                color: swalColor
            }).then((result) => {
                if (result.isConfirmed) {

                     // --- KRİTİK DÜZELTME BURADA ---
                     // formData yerine kendi objemizi oluşturuyoruz.
                     // Böylece "5,4" yerine "5.4" (number) gidiyor ve sunucu bunu doğru anlıyor.

                     var sendData = {
                         sourceAccountId: $('#sourceAccountId').val(),
                         targetAccountId: $('#targetAccountId').val(),
                         amount: amount,          // Düzeltilmiş sayı (noktalı)
                         commission: commission,  // Düzeltilmiş sayı (noktalı)
                         date: $('input[name="date"]').val(),
                         description: $('textarea[name="description"]').val(),
                         // Güvenlik token'ını elle eklememiz şart!
                         __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                     };

                     $.ajax({
                        url: '/MoneyTransfer/MakeTransfer',
                        type: 'POST',
                        data: sendData, // formData YERİNE sendData gönderiyoruz
                        success: function(res) {
                            if (res.success) {
                                Swal.fire({
                                    title: 'Başarılı!',
                                    text: res.message,
                                    icon: 'success',
                                    background: swalBackground,
                                    color: swalColor
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    title: 'Hata!',
                                    text: res.message,
                                    icon: 'error',
                                    background: swalBackground,
                                    color: swalColor
                                });
                            }
                        },
                        error: function() {
                            Swal.fire({
                                title: 'Hata!',
                                text: 'Sunucu hatası oluştu.',
                                icon: 'error',
                                background: swalBackground,
                                color: swalColor
                            });
                        }
                    });
                }
            });
        });
        });
    </script>
}